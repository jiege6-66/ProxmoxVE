# core.func 函数参考

## 概述

本文档提供 `core.func` 中所有函数的完整字母顺序参考，包括参数、依赖关系、使用示例和错误处理。

## 函数类别

### 初始化函数

#### `load_functions()`
**目的**：初始化所有核心实用工具的主函数加载器
**参数**：无
**返回**：无
**副作用**：
- 设置 `__FUNCTIONS_LOADED=1` 以防止重新加载
- 按顺序调用所有核心函数组
- 初始化颜色、格式化、图标、默认值和标准模式
**依赖关系**：无
**使用的环境变量**：`__FUNCTIONS_LOADED`

**使用示例**：
```bash
# 引用 core.func 时自动调用
source core.func
# load_functions() 自动调用
```

### 颜色和格式化函数

#### `color()`
**目的**：为样式化终端输出设置 ANSI 颜色代码
**参数**：无
**返回**：无
**副作用**：设置全局颜色变量
**依赖关系**：无
**使用的环境变量**：无

**设置的变量**：
- `YW`：黄色
- `YWB`：亮黄色
- `BL`：蓝色
- `RD`：红色
- `BGN`：亮绿色
- `GN`：绿色
- `DGN`：深绿色
- `CL`：清除/重置

**使用示例**：
```bash
color
echo -e "${GN}成功消息${CL}"
echo -e "${RD}错误消息${CL}"
```

#### `color_spinner()`
**目的**：专门为旋转器输出设置颜色代码
**参数**：无
**返回**：无
**副作用**：设置旋转器特定的颜色变量
**依赖关系**：无
**使用的环境变量**：无

**设置的变量**：
- `CS_YW`：旋转器黄色
- `CS_YWB`：旋转器亮黄色
- `CS_CL`：旋转器清除

#### `formatting()`
**目的**：定义终端输出的格式化助手
**参数**：无
**返回**：无
**副作用**：设置全局格式化变量
**依赖关系**：无
**使用的环境变量**：无

**设置的变量**：
- `BFR`：后退和前进重置
- `BOLD`：粗体文本
- `HOLD`：空格字符
- `TAB`：两个空格
- `TAB3`：六个空格

### 图标函数

#### `icons()`
**目的**：设置用于用户反馈和提示的符号图标
**参数**：无
**返回**：无
**副作用**：设置全局图标变量
**依赖关系**：`formatting()`（用于 TAB 变量）
**使用的环境变量**：`TAB`、`CL`

**设置的变量**：
- `CM`：复选标记
- `CROSS`：叉号
- `DNSOK`：DNS 成功
- `DNSFAIL`：DNS 失败
- `INFO`：信息图标
- `OS`：操作系统图标
- `OSVERSION`：OS 版本图标
- `CONTAINERTYPE`：容器类型图标
- `DISKSIZE`：磁盘大小图标
- `CPUCORE`：CPU 核心图标
- `RAMSIZE`：RAM 大小图标
- `SEARCH`：搜索图标
- `VERBOSE_CROPPED`：详细模式图标
- `VERIFYPW`：密码验证图标
- `CONTAINERID`：容器 ID 图标
- `HOSTNAME`：主机名图标
- `BRIDGE`：桥接图标
- `NETWORK`：网络图标
- `GATEWAY`：网关图标
- `DISABLEIPV6`：IPv6 禁用图标
- `DEFAULT`：默认设置图标
- `MACADDRESS`：MAC 地址图标
- `VLANTAG`：VLAN 标签图标
- `ROOTSSH`：SSH 密钥图标
- `CREATING`：创建图标
- `ADVANCED`：高级设置图标
- `FUSE`：FUSE 图标
- `HOURGLASS`：沙漏图标

### 默认变量函数

#### `default_vars()`
**目的**：为系统操作设置默认重试和等待变量
**参数**：无
**返回**：无
**副作用**：设置重试配置变量
**依赖关系**：无
**使用的环境变量**：无

**设置的变量**：
- `RETRY_NUM`：重试尝试次数（默认：10）
- `RETRY_EVERY`：重试间隔秒数（默认：3）
- `i`：重试计数器初始化为 RETRY_NUM

#### `set_std_mode()`
**目的**：为脚本执行设置默认详细模式
**参数**：无
**返回**：无
**副作用**：根据 VERBOSE 设置设置 STD 变量
**依赖关系**：无
**使用的环境变量**：`VERBOSE`

**设置的变量**：
- `STD`：如果 VERBOSE != "yes" 则为 "silent"，如果 VERBOSE = "yes" 则为空字符串

### 静默执行函数

#### `silent()`
**目的**：使用详细错误报告静默执行命令
**参数**：`$*` - 要执行的命令和参数
**返回**：无（错误时退出）
**副作用**：
- 执行命令并将输出重定向到日志文件
- 错误时显示详细错误信息
- 以命令的退出代码退出
**依赖关系**：`error_handler.func`（用于错误说明）
**使用的环境变量**：`SILENT_LOGFILE`

**使用示例**：
```bash
silent apt-get update
silent apt-get install -y package-name
```

**错误处理**：
- 将命令输出捕获到 `/tmp/silent.$$.log`
- 显示错误代码说明
- 显示日志的最后 10 行
- 提供查看完整日志的命令

### 系统检查函数

#### `shell_check()`
**目的**：验证脚本在 Bash shell 中运行
**参数**：无
**返回**：无（如果不是 Bash 则退出）
**副作用**：
- 检查当前 shell 进程
- 如果不是 Bash 则以错误消息退出
**依赖关系**：无
**使用的环境变量**：无

**使用示例**：
```bash
shell_check
# 如果是 Bash 则脚本继续，否则退出
```

#### `root_check()`
**目的**：确保脚本以 root 用户身份运行
**参数**：无
**返回**：无（如果不是 root 则退出）
**副作用**：
- 检查用户 ID 和父进程
- 如果不是 root 则以错误消息退出
**依赖关系**：无
**使用的环境变量**：无

**使用示例**：
```bash
root_check
# 如果是 root 则脚本继续，否则退出
```

#### `pve_check()`
**目的**：验证 Proxmox VE 版本兼容性
**参数**：无
**返回**：无（如果版本不支持则退出）
**副作用**：
- 使用 pveversion 命令检查 PVE 版本
- 如果不支持则以错误消息退出
**依赖关系**：`pveversion` 命令
**使用的环境变量**：无

**支持的版本**：
- Proxmox VE 8.0 - 8.9
- Proxmox VE 9.0（仅限）

**使用示例**：
```bash
pve_check
# 如果是支持的版本则脚本继续，否则退出
```

#### `arch_check()`
**目的**：验证系统架构是 AMD64
**参数**：无
**返回**：无（如果不是 AMD64 则退出）
**副作用**：
- 检查系统架构
- 如果不是 AMD64 则以 PiMox 警告退出
**依赖关系**：`dpkg` 命令
**使用的环境变量**：无

**使用示例**：
```bash
arch_check
# 如果是 AMD64 则脚本继续，否则退出
```

#### `ssh_check()`
**目的**：检测并警告外部 SSH 使用
**参数**：无
**返回**：无
**副作用**：
- 检查 SSH_CLIENT 环境变量
- 如果从外部 IP 连接则警告
- 允许本地连接（127.0.0.1 或主机 IP）
**依赖关系**：无
**使用的环境变量**：`SSH_CLIENT`

**使用示例**：
```bash
ssh_check
# 如果是外部 SSH 则显示警告，无论如何继续
```

### 头部管理函数

#### `get_header()`
**目的**：下载并缓存应用程序头文件
**参数**：无（使用 APP 和 APP_TYPE 变量）
**返回**：成功时返回头部内容，失败时为空
**副作用**：
- 从远程 URL 下载头部
- 本地缓存头部
- 如需要创建目录结构
**依赖关系**：`curl` 命令
**使用的环境变量**：`APP`、`APP_TYPE`

**使用示例**：
```bash
export APP="plex"
export APP_TYPE="ct"
header_content=$(get_header)
```

#### `header_info()`
**目的**：显示应用程序头部信息
**参数**：无（使用 APP 变量）
**返回**：无
**副作用**：
- 清除屏幕
- 显示头部内容
- 获取终端宽度以进行格式化
**依赖关系**：`get_header()`、`tput` 命令
**使用的环境变量**：`APP`

**使用示例**：
```bash
export APP="plex"
header_info
# 显示 Plex 头部信息
```

### 实用函数

#### `ensure_tput()`
**目的**：确保 tput 命令可用于终端控制
**参数**：无
**返回**：无
**副作用**：
- 如果 tput 缺失则安装 ncurses 包
- 在 Alpine 和基于 Debian 的系统上工作
**依赖关系**：`apk` 或 `apt-get` 包管理器
**使用的环境变量**：无

**使用示例**：
```bash
ensure_tput
# 如需要安装 ncurses，如果已可用则继续
```

#### `is_alpine()`
**目的**：检测是否在 Alpine Linux 上运行
**参数**：无
**返回**：如果是 Alpine 则为 0，如果不是 Alpine 则为 1
**副作用**：无
**依赖关系**：无
**使用的环境变量**：`var_os`、`PCT_OSTYPE`

**使用示例**：
```bash
if is_alpine; then
    echo "在 Alpine Linux 上运行"
else
    echo "不在 Alpine Linux 上运行"
fi
```

#### `is_verbose_mode()`
**目的**：检查是否启用详细模式
**参数**：无
**返回**：如果是详细模式则为 0，如果不是详细则为 1
**副作用**：无
**依赖关系**：无
**使用的环境变量**：`VERBOSE`、`var_verbose`

**使用示例**：
```bash
if is_verbose_mode; then
    echo "详细模式已启用"
else
    echo "详细模式已禁用"
fi
```

#### `fatal()`
**目的**：显示致命错误并终止脚本
**参数**：`$1` - 错误消息
**返回**：无（终止脚本）
**副作用**：
- 显示错误消息
- 向当前进程发送 INT 信号
**依赖关系**：`msg_error()`
**使用的环境变量**：无

**使用示例**：
```bash
fatal "发生严重错误"
# 显示错误后脚本终止
```

### 旋转器函数

#### `spinner()`
**目的**：显示动画旋转器以指示进度
**参数**：无（使用 SPINNER_MSG 变量）
**返回**：无（无限期运行）
**副作用**：
- 显示旋转的旋转器字符
- 使用终端控制序列
**依赖关系**：`color_spinner()`
**使用的环境变量**：`SPINNER_MSG`

**使用示例**：
```bash
SPINNER_MSG="正在处理..."
spinner &
SPINNER_PID=$!
# 旋转器在后台运行
```

#### `clear_line()`
**目的**：清除当前终端行
**参数**：无
**返回**：无
**副作用**：使用终端控制清除当前行
**依赖关系**：`tput` 命令
**使用的环境变量**：无

#### `stop_spinner()`
**目的**：停止运行的旋转器并清理
**参数**：无
**返回**：无
**副作用**：
- 终止旋转器进程
- 删除 PID 文件
- 重置终端设置
- 取消设置旋转器变量
**依赖关系**：无
**使用的环境变量**：`SPINNER_PID`、`SPINNER_MSG`

**使用示例**：
```bash
stop_spinner
# 停止旋转器并清理
```

### 消息函数

#### `msg_info()`
**目的**：显示带旋转器的信息消息
**参数**：`$1` - 消息文本
**返回**：无
**副作用**：
- 如果不在详细模式则启动旋转器
- 跟踪显示的消息以防止重复
- 在详细模式下显示带沙漏图标的消息
**依赖关系**：`spinner()`、`is_verbose_mode()`、`is_alpine()`
**使用的环境变量**：`MSG_INFO_SHOWN`

**使用示例**：
```bash
msg_info "正在安装包..."
# 显示带消息的旋转器
```

#### `msg_ok()`
**目的**：显示成功消息
**参数**：`$1` - 成功消息文本
**返回**：无
**副作用**：
- 停止旋转器
- 显示带消息的绿色复选标记
- 从显示跟踪中删除消息
**依赖关系**：`stop_spinner()`
**使用的环境变量**：`MSG_INFO_SHOWN`

**使用示例**：
```bash
msg_ok "包安装成功"
# 显示带消息的绿色复选标记
```

#### `msg_error()`
**目的**：显示错误消息
**参数**：`$1` - 错误消息文本
**返回**：无
**副作用**：
- 停止旋转器
- 显示带消息的红色叉号
**依赖关系**：`stop_spinner()`
**使用的环境变量**：无

**使用示例**：
```bash
msg_error "安装失败"
# 显示带消息的红色叉号
```

#### `msg_warn()`
**目的**：显示警告消息
**参数**：`$1` - 警告消息文本
**返回**：无
**副作用**：
- 停止旋转器
- 显示带消息的黄色信息图标
**依赖关系**：`stop_spinner()`
**使用的环境变量**：无

**使用示例**：
```bash
msg_warn "此操作可能需要一些时间"
# 显示带消息的黄色信息图标
```

#### `msg_custom()`
**目的**：显示带指定符号和颜色的自定义消息
**参数**：
- `$1` - 自定义符号（默认："[*]"）
- `$2` - 颜色代码（默认："\e[36m"）
- `$3` - 消息文本
**返回**：无
**副作用**：
- 停止旋转器
- 显示自定义格式的消息
**依赖关系**：`stop_spinner()`
**使用的环境变量**：无

**使用示例**：
```bash
msg_custom "⚡" "\e[33m" "自定义警告消息"
# 显示带消息的自定义符号和颜色
```

#### `msg_debug()`
**目的**：如果启用调试模式则显示调试消息
**参数**：`$*` - 调试消息文本
**返回**：无
**副作用**：
- 仅在设置 var_full_verbose 时显示
- 显示时间戳和调试前缀
**依赖关系**：无
**使用的环境变量**：`var_full_verbose`、`var_verbose`

**使用示例**：
```bash
export var_full_verbose=1
msg_debug "这里的调试信息"
# 显示带时间戳的调试消息
```

### 系统管理函数

#### `check_or_create_swap()`
**目的**：检查活动交换并可选择创建交换文件
**参数**：无
**返回**：如果交换存在或已创建则为 0，如果跳过则为 1
**副作用**：
- 检查活动交换
- 如果未找到则提示用户创建交换
- 如果用户确认则创建交换文件
**依赖关系**：`swapon`、`dd`、`mkswap` 命令
**使用的环境变量**：无

**使用示例**：
```bash
if check_or_create_swap; then
    echo "交换可用"
else
    echo "交换不可用"
fi
```

## 函数调用层次结构

### 初始化流程
```
load_functions()
├── color()
├── formatting()
├── icons()
├── default_vars()
└── set_std_mode()
```

### 消息系统流程
```
msg_info()
├── is_verbose_mode()
├── is_alpine()
├── spinner()
└── color_spinner()

msg_ok()
├── stop_spinner()
└── clear_line()

msg_error()
└── stop_spinner()

msg_warn()
└── stop_spinner()
```

### 系统检查流程
```
pve_check()
├── pveversion 命令
└── 版本解析

arch_check()
├── dpkg 命令
└── 架构检查

shell_check()
├── ps 命令
└── shell 检测

root_check()
├── id 命令
└── 父进程检查
```

### 静默执行流程
```
silent()
├── 命令执行
├── 输出重定向
├── 错误处理
├── error_handler.func 加载
└── 日志管理
```

## 错误处理模式

### 系统检查错误
- 所有系统检查函数以适当的错误消息退出
- 清楚指示问题所在以及如何修复
- 优雅退出，延迟以便用户阅读消息

### 静默执行错误
- 通过 `silent()` 执行的命令将输出捕获到日志文件
- 失败时显示错误代码说明
- 显示日志输出的最后 10 行
- 提供查看完整日志的命令

### 旋转器错误
- 旋转器函数处理退出时的进程清理
- 陷阱处理程序确保旋转器停止
- 错误时恢复终端设置

## 环境变量依赖关系

### 必需变量
- `APP`：头部显示的应用程序名称
- `APP_TYPE`：头部路径的应用程序类型（ct/vm）
- `VERBOSE`：详细模式设置

### 可选变量
- `var_os`：Alpine 检测的 OS 类型
- `PCT_OSTYPE`：替代 OS 类型变量
- `var_verbose`：替代详细设置
- `var_full_verbose`：调试模式设置

### 内部变量
- `_CORE_FUNC_LOADED`：防止多次加载
- `__FUNCTIONS_LOADED`：防止多次函数加载
- `SILENT_LOGFILE`：静默执行日志文件路径
- `SPINNER_PID`：旋转器进程 ID
- `SPINNER_MSG`：旋转器消息文本
- `MSG_INFO_SHOWN`：跟踪显示的信息消息
