# core.func 执行流程图

## 主执行流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            core.func 加载                                       │
│  其他脚本引用 core.func 时的入口点                                              │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        加载防止检查                                             │
│  • 检查 _CORE_FUNC_LOADED 是否已设置                                           │
│  • 如果已加载则提前返回                                                         │
│  • 设置 _CORE_FUNC_LOADED=1 以防止重新加载                                     │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        LOAD_FUNCTIONS()                                        │
│  主函数加载器 - 设置所有核心实用工具                                            │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        核心函数加载序列                                         │
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐     │
│  │   color()       │  │ formatting()   │  │        icons()              │     │
│  │                 │  │                │  │                             │     │
│  │ • 设置 ANSI     │  │ • 设置格式     │  │ • 设置符号图标              │     │
│  │   颜色代码      │  │   助手         │  │ • 定义消息                  │     │
│  │ • 定义          │  │ • Tab、粗体、  │  │   符号                      │     │
│  │   颜色          │  │   行重置       │  │ • 状态指示器                │     │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘     │
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐     │
│  │ default_vars()  │  │ set_std_mode()  │  │    附加函数                 │     │
│  │                 │  │                 │  │                             │     │
│  │ • 设置重试      │  │ • 设置详细      │  │ • 根据需要添加              │     │
│  │   变量          │  │   模式          │  │   更多函数                  │     │
│  │ • 初始化        │  │ • 配置          │  │                             │     │
│  │   计数器        │  │   STD 变量      │  │                             │     │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 系统检查函数流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        系统验证流程                                             │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        PVE_CHECK()                                        │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   获取 PVE      │    │   检查 PVE      │    │   检查 PVE          │ │ │
│  │  │   版本          │    │   8.x 支持      │    │   9.x 支持          │ │ │
│  │  │                 │    │                 │    │                     │ │ │
│  │  │ • pveversion    │    │ • 允许 8.0-8.9  │    │ • 仅允许 9.0        │ │ │
│  │  │ • 解析版本      │    │ • 拒绝其他      │    │ • 拒绝 9.1+         │ │ │
│  │  │ • 提取          │    │ • 如果不支持    │    │ • 如果不支持        │ │ │
│  │  │   主版本.次版本 │    │   则退出        │    │   则退出            │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        ARCH_CHECK()                                       │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   检查          │    │   AMD64 检查    │    │   PiMox 警告        │ │ │
│  │  │   架构          │    │                 │    │                     │ │ │
│  │  │                 │    │ • dpkg --print- │    │ • 显示 PiMox        │ │ │
│  │  │ • 获取系统      │    │   architecture  │    │   消息              │ │ │
│  │  │   架构          │    │ • 必须是        │    │ • 指向 ARM64        │ │ │
│  │  │ • 与 "amd64"    │    │   "amd64"       │    │   支持              │ │ │
│  │  │   比较          │    │ • 如果不是则    │    │ • 退出脚本          │ │ │
│  │  │                 │    │   退出          │    │                     │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        SHELL_CHECK()                                      │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   检查          │    │   Bash 检查     │    │   错误处理          │ │ │
│  │  │   Shell 类型    │    │                 │    │                     │ │ │
│  │  │                 │    │ • ps -p $$ -o   │    │ • 清除屏幕          │ │ │
│  │  │ • 获取当前      │    │   comm=         │    │ • 显示错误          │ │ │
│  │  │   shell         │    │ • 必须是        │    │ • 休眠并退出        │ │ │
│  │  │ • 与 "bash"     │    │   "bash"        │    │                     │ │ │
│  │  │   比较          │    │ • 如果不是则    │    │                     │ │ │
│  │  │                 │    │   退出          │    │                     │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        ROOT_CHECK()                                       │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   检查          │    │   Root 检查     │    │   Sudo 检查         │ │ │
│  │  │   用户 ID       │    │                 │    │                     │ │ │
│  │  │                 │    │ • id -u         │    │ • 检查父            │ │ │
│  │  │ • 获取用户 ID   │    │ • 必须是 0      │    │   进程              │ │ │
│  │  │ • 检查是否      │    │ • 如果不是则    │    │ • 检测 sudo         │ │ │
│  │  │   为 root (0)   │    │   退出          │    │   使用              │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 消息系统流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        消息系统流程                                             │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        MSG_INFO()                                         │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   消息          │    │   重复          │    │   显示模式          │ │ │
│  │  │   验证          │    │   检查          │    │   选择              │ │ │
│  │  │                 │    │                 │    │                     │ │ │
│  │  │ • 检查消息      │    │ • 跟踪已显示    │    │ • 详细模式：        │ │ │
│  │  │   是否存在      │    │   的消息        │    │   直接显示          │ │ │
│  │  │ • 如果为空      │    │ • 如果已显示    │    │ • 正常模式：        │ │ │
│  │  │   则返回        │    │   则跳过        │    │   启动旋转器        │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        SPINNER()                                          │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   旋转器        │    │   动画          │    │   显示              │ │ │
│  │  │   初始化        │    │   循环          │    │   控制              │ │ │
│  │  │                 │    │                 │    │                     │ │ │
│  │  │ • 定义          │    │ • 循环遍历      │    │ • 打印旋转器        │ │ │
│  │  │   字符          │    │   字符          │    │   字符              │ │ │
│  │  │ • 设置索引      │    │ • 休眠 0.1s     │    │ • 打印消息          │ │ │
│  │  │ • 启动循环      │    │ • 递增          │    │ • 清除行            │ │ │
│  │  │                 │    │   索引          │    │                     │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        STOP_SPINNER()                                     │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   获取旋转器    │    │   终止进程      │    │   清理              │ │ │
│  │  │   PID           │    │                 │    │                     │ │ │
│  │  │                 │    │ • 发送 TERM     │    │ • 删除 PID 文件     │ │ │
│  │  │ • 从            │    │ • 等待          │    │ • 取消设置变量      │ │ │
│  │  │   SPINNER_PID   │    │   终止          │    │ • 重置终端          │ │ │
│  │  │ • 从 PID        │    │ • 如需要        │    │   设置              │ │ │
│  │  │   文件          │    │   强制终止      │    │                     │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 静默执行流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        SILENT() 执行流程                                        │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        命令执行                                            │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   设置          │    │   执行          │    │   捕获输出          │ │ │
│  │  │   环境          │    │   命令          │    │                     │ │ │
│  │  │                 │    │                 │    │ • 重定向 stdout     │ │ │
│  │  │ • 禁用          │    │ • 运行命令      │    │   到日志文件        │ │ │
│  │  │   错误          │    │ • 捕获          │    │ • 重定向 stderr     │ │ │
│  │  │   处理          │    │   返回代码      │    │   到日志文件        │ │ │
│  │  │ • 删除          │    │ • 存储退出      │    │ • 记录所有输出      │ │ │
│  │  │   陷阱          │    │   代码          │    │                     │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        错误处理                                            │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   检查退出      │    │   加载错误      │    │   显示错误          │ │ │
│  │  │   代码          │    │   处理程序      │    │   信息              │ │ │
│  │  │                 │    │                 │    │                     │ │ │
│  │  │ • 如果退出代码  │    │ • 引用          │    │ • 显示错误代码      │ │ │
│  │  │   != 0          │    │   error_handler │    │ • 显示说明          │ │ │
│  │  │ • 继续到        │    │   如需要        │    │ • 显示命令          │ │ │
│  │  │   错误          │    │ • 获取错误      │    │ • 显示日志行        │ │ │
│  │  │   处理          │    │   说明          │    │ • 显示完整日志      │ │ │
│  │  │                 │    │                 │    │   命令              │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        日志管理                                            │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   日志文件      │    │   日志显示      │    │   日志访问          │ │ │
│  │  │   管理          │    │                 │    │                     │ │ │
│  │  │                 │    │ • 显示最后 10   │    │ • 提供查看          │ │ │
│  │  │ • 创建日志      │    │   行            │    │   完整日志的        │ │ │
│  │  │   文件路径      │    │ • 计算总        │    │   命令              │ │ │
│  │  │ • 在名称中      │    │   行数          │    │ • 显示行数          │ │ │
│  │  │   使用进程 ID   │    │ • 格式化        │    │ • 启用调试          │ │ │
│  │  │                 │    │   输出          │    │                     │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 头部管理流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        头部管理流程                                             │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        GET_HEADER()                                       │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   准备          │    │   检查本地      │    │   下载头部          │ │ │
│  │  │   参数          │    │   文件          │    │                     │ │ │
│  │  │                 │    │                 │    │ • 构造 URL          │ │ │
│  │  │ • 从 APP        │    │ • 检查文件      │    │ • 下载文件          │ │ │
│  │  │   获取应用名    │    │   是否存在      │    │ • 保存到本地        │ │ │
│  │  │ • 从 APP_TYPE   │    │ • 检查文件      │    │   路径              │ │ │
│  │  │   获取应用类型  │    │   是否有        │    │ • 返回成功          │ │ │
│  │  │ • 构造          │    │   内容          │    │   状态              │ │ │
│  │  │   路径          │    │ • 如果可用      │    │                     │ │ │
│  │  │                 │    │   则返回        │    │                     │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        HEADER_INFO()                                      │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   获取头部      │    │   清除屏幕      │    │   显示头部          │ │ │
│  │  │   内容          │    │                 │    │                     │ │ │
│  │  │                 │    │ • 清除          │    │ • 如果可用          │ │ │
│  │  │ • 调用          │    │   终端          │    │   显示头部          │ │ │
│  │  │   get_header()  │    │ • 获取终端      │    │   内容              │ │ │
│  │  │ • 处理          │    │   宽度          │    │ • 格式化输出        │ │ │
│  │  │   错误          │    │ • 如需要        │    │ • 如可能            │ │ │
│  │  │ • 返回          │    │   设置默认      │    │   居中内容          │ │ │
│  │  │   内容          │    │   宽度          │    │                     │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 交换管理流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        CHECK_OR_CREATE_SWAP() 流程                             │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        交换检测                                            │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   检查活动      │    │   找到交换      │    │   未找到交换        │ │ │
│  │  │   交换          │    │                 │    │                     │ │ │
│  │  │                 │    │ • 显示成功      │    │ • 显示错误          │ │ │
│  │  │ • 使用 swapon   │    │   消息          │    │   消息              │ │ │
│  │  │   命令          │    │ • 返回 0        │    │ • 询问用户          │ │ │
│  │  │ • 检查          │    │                 │    │   是否创建          │ │ │
│  │  │   交换设备      │    │                 │    │ • 继续到            │ │ │
│  │  │ • 返回          │    │                 │    │   创建流程          │ │ │
│  │  │   状态          │    │                 │    │                     │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        交换创建                                            │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   用户输入      │    │   大小          │    │   文件创建          │ │ │
│  │  │   收集          │    │   验证          │    │                     │ │ │
│  │  │                 │    │                 │    │ • 使用 dd           │ │ │
│  │  │ • 询问          │    │ • 验证          │    │   创建交换文件      │ │ │
│  │  │   确认          │    │   数字输入      │    │ • 设置权限          │ │ │
│  │  │ • 转换为        │    │ • 检查范围      │    │ • 格式化交换        │ │ │
│  │  │   小写          │    │ • 如果无效      │    │ • 激活交换          │ │ │
│  │  │ • 检查          │    │   则中止        │    │ • 显示成功          │ │ │
│  │  │   y/yes         │    │                 │    │   消息              │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 集成点

### 与其他脚本集成
- **build.func**：提供系统检查和 UI 函数
- **tools.func**：使用核心实用工具进行扩展操作
- **api.func**：使用系统检查和错误处理
- **error_handler.func**：为静默执行提供错误说明

### 外部依赖
- **curl**：用于下载头文件
- **tput**：用于终端控制（如缺失则安装）
- **swapon/mkswap**：用于交换管理
- **pveversion**：用于 Proxmox 版本检查

### 数据流
- **输入**：环境变量、命令参数
- **处理**：系统验证、UI 渲染、命令执行
- **输出**：消息、日志文件、退出代码、系统状态更改
