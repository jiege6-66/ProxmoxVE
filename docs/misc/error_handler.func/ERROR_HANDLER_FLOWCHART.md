# error_handler.func 执行流程图

## 主要错误处理流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        错误处理器初始化                                          │
│  当其他脚本引用 error_handler.func 时的入口点                                    │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        CATCH_ERRORS()                                           │
│  初始化错误处理陷阱和严格模式                                                     │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        陷阱设置序列                                              │
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐      │
│  │   设置严格      │  │   设置错误      │  │     设置信号                │      │
│  │   模式          │  │   陷阱          │  │     陷阱                    │      │
│  │                 │  │                 │  │                             │      │
│  │ • -Ee           │  │ • ERR trap      │  │ • EXIT trap                 │      │
│  │ • -o pipefail   │  │ • error_handler │  │ • INT trap                  │      │
│  │ • -u (如果      │  │   函数          │  │ • TERM trap                 │      │
│  │   STRICT_UNSET) │  │                 │  │                             │      │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 错误处理器流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        ERROR_HANDLER() 流程                                     │
│  由 ERR 陷阱触发或手动调用的主错误处理器                                          │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        错误检测                                                  │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    错误信息收集                                              │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   获取退出      │    │   获取命令      │    │   获取行            │ │ │
│  │  │   代码          │    │   信息          │    │   号                │ │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 从 $? 或      │    │ • 从            │    │ • 从                │ │ │
│  │  │   参数获取      │    │   BASH_COMMAND  │    │   BASH_LINENO[0]    │ │ │
│  │  │ • 存储到        │    │   获取          │    │   获取              │ │ │
│  │  │   exit_code     │    │ • 清理 $STD     │    │ • 默认为            │ │ │
│  │  │                 │    │   引用          │    │   "unknown"         │ │ │
│  │  │                 │    │ • 存储到        │    │ • 存储到            │ │ │
│  │  │                 │    │   command       │    │   line_number       │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        成功检查                                                  │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    退出代码验证                                              │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   检查退出      │    │   成功          │    │   错误              │ │ │
│  │  │   代码          │    │   路径          │    │   路径              │ │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 如果 exit_code│    │ • 返回 0        │    │ • 继续进行          │ │
│  │  │   == 0          │    │ • 无错误        │    │   错误处理          │ │
│  │  │ • 成功          │    │   处理          │    │ • 处理错误          │ │
│  │  │ • 无错误        │    │                 │    │   信息              │ │
│  │  │   处理          │    │                 │    │                     │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        错误处理                                                  │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    错误说明                                                  │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   获取错误      │    │   显示错误      │    │   记录错误          │ │ │
│  │  │   说明          │    │   信息          │    │   信息              │ │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 调用          │    │ • 显示错误      │    │ • 如果启用则        │ │ │
│  │  │   explain_exit_ │    │   消息          │    │   写入调试日志      │ │ │
│  │  │   code()        │    │ • 显示行        │    │ • 包含              │ │ │
│  │  │ • 获取人类      │    │   号            │    │   时间戳            │ │ │
│  │  │   可读消息      │    │ • 显示命令      │    │ • 包含退出          │ │ │
│  │  │                 │    │ • 显示退出      │    │   代码              │ │ │
│  │  │                 │    │   代码          │    │ • 包含命令          │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        静默日志集成                                              │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    静默日志显示                                              │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   检查静默      │    │   显示日志      │    │   以错误代码        │ │ │
│  │  │   日志文件      │    │   内容          │    │   退出              │ │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 检查是否      │    │ • 显示最后 20   │    │ • 以原始退出        │ │ │
│  │  │   设置了 SILENT_│    │   行            │    │   代码退出          │ │ │
│  │  │   LOGFILE       │    │ • 显示文件      │    │ • 终止脚本          │ │ │
│  │  │ • 检查文件      │    │   路径          │    │   执行              │ │ │
│  │  │   是否存在      │    │ • 格式化        │    │                     │ │ │
│  │  │ • 检查文件      │    │   输出          │    │                     │ │ │
│  │  │   是否有内容    │    │                 │    │                     │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 信号处理流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        信号处理器流程                                            │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        信号检测                                              │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   SIGINT        │    │   SIGTERM       │    │     EXIT            │ │ │
│  │  │   (Ctrl+C)      │    │   (终止)        │    │     (脚本结束)      │ │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 用户          │    │ • 系统          │    │ • 正常脚本          │ │ │
│  │  │   中断          │    │   终止          │    │   完成              │ │ │
│  │  │ • 优雅          │    │ • 优雅          │    │ • 错误退出          │ │ │
│  │  │   处理          │    │   处理          │    │ • 信号退出          │ │ │
│  │  │ • 退出代码      │    │ • 退出代码      │    │ • 清理              │ │ │
│  │  │   130           │    │   143           │    │   操作              │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        ON_INTERRUPT() 流程                                      │
│  处理 SIGINT (Ctrl+C) 信号                                                      │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        中断处理                                                  │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    用户中断处理                                              │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   显示          │    │   清理          │    │   以代码 130        │ │ │
│  │  │   消息          │    │   操作          │    │   退出              │ │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 显示          │    │ • 停止          │    │ • 以 SIGINT 代码    │ │ │
│  │  │   中断消息      │    │   进程          │    │   退出              │ │ │
│  │  │ • 使用红色      │    │ • 清理          │    │ • 终止脚本          │ │ │
│  │  │ • 清除          │    │   临时文件      │    │   执行              │ │ │
│  │  │   终端          │    │ • 删除锁        │    │                     │ │ │
│  │  │                 │    │   文件          │    │                     │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 退出处理器流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        ON_EXIT() 流程                                           │
│  处理脚本退出清理                                                                │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        退出清理                                                  │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    清理操作                                                  │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   锁文件        │    │   临时文件      │    │   以原始代码        │ │ │
│  │  │   清理          │    │   清理          │    │   退出              │ │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 检查是否      │    │ • 删除          │    │ • 以原始退出        │ │ │
│  │  │   设置了 lockfile│   │   临时文件      │    │   代码退出          │ │ │
│  │  │   变量          │    │ • 清理          │    │ • 保留退出          │ │ │
│  │  │ • 检查 lockfile │    │   进程状态      │    │   状态              │ │ │
│  │  │   是否存在      │    │                 │    │ • 终止              │ │ │
│  │  │ • 删除          │    │                 │    │   执行              │ │ │
│  │  │   lockfile      │    │                 │    │                     │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 错误代码说明流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        EXPLAIN_EXIT_CODE() 流程                                 │
│  将数字退出代码转换为人类可读的说明                                              │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        错误代码分类                                              │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    错误代码类别                                              │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   通用/         │    │   包管理器      │    │   Node.js           │ │ │
│  │  │   Shell         │    │   错误          │    │   错误              │ │ │
│  │  │   错误          │    │                 │    │                     │ │
│  │  │                 │    │ • 100: APT      │    │ • 243: 内存不足     │ │ │
│  │  │ • 1: 一般       │    │   包错误        │    │ • 245: 无效选项     │ │ │
│  │  │   错误          │    │ • 101: APT      │    │ • 246: 解析错误     │ │ │
│  │  │ • 2: Shell      │    │   配置错误      │    │ • 247: 致命错误     │ │ │
│  │  │   内置命令      │    │ • 255: DPKG     │    │ • 248: 插件失败     │ │ │
│  │  │   误用          │    │   致命错误      │    │ • 249: 检查器错误   │ │ │
│  │  │ • 126: 无法     │    │                 │    │ • 254: 未知致命     │ │ │
│  │  │   执行          │    │                 │    │   错误              │ │ │
│  │  │ • 127: 命令     │    │                 │    │                     │ │ │
│  │  │   未找到        │    │                 │    │                     │ │ │
│  │  │ • 128: 无效     │    │                 │    │                     │ │ │
│  │  │   退出          │    │                 │    │                     │ │ │
│  │  │ • 130: SIGINT   │    │                 │    │                     │ │ │
│  │  │ • 137: SIGKILL  │    │                 │    │                     │ │ │
│  │  │ • 139: 段错误   │    │                 │    │                     │ │ │
│  │  │ • 143: SIGTERM  │    │                 │    │                     │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   Python        │    │   数据库        │    │   Proxmox           │ │ │
│  │  │   错误          │    │   错误          │    │   自定义错误        │ │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 210: 虚拟     │    │ • PostgreSQL:   │    │ • 200: 锁文件失败   │ │ │
│  │  │   环境缺失      │    │   231-234       │    │ • 203: 缺少 CTID    │ │ │
│  │  │ • 211: 依赖     │    │ • MySQL: 241-   │    │ • 204: 缺少         │ │ │
│  │  │   解析          │    │   244           │    │   PCT_OSTYPE        │ │ │
│  │  │ • 212: 安装     │    │ • MongoDB: 251- │    │ • 205: 无效 CTID    │ │ │
│  │  │   中止          │    │   254           │    │ • 209: 容器创建     │ │ │
│  │  │                 │    │                 │    │   失败              │ │ │
│  │  │                 │    │                 │    │ • 210: 集群未达到   │ │ │
│  │  │                 │    │                 │    │   法定人数          │ │ │
│  │  │                 │    │                 │    │ • 214: 无存储空间   │ │ │
│  │  │                 │    │                 │    │ • 215: CTID 未列出  │ │ │
│  │  │                 │    │                 │    │ • 216: RootFS 缺失  │ │ │
│  │  │                 │    │                 │    │ • 217: 存储不支持   │ │ │
│  │  │                 │    │                 │    │ • 220: 模板路径     │ │ │
│  │  │                 │    │                 │    │   错误              │ │ │
│  │  │                 │    │                 │    │ • 222: 模板下载     │ │ │
│  │  │                 │    │                 │    │   失败              │ │ │
│  │  │                 │    │                 │    │ • 223: 模板不可用   │ │ │
│  │  │                 │    │                 │    │ • 231: LXC 栈升级   │ │ │
│  │  │                 │    │                 │    │   失败              │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        默认情况                                                  │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    未知错误处理                                              │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   检查未知      │    │   返回          │    │   记录未知错误      │ │ │
│  │  │   代码          │    │   通用消息      │    │                     │ │
│  │  │                 │    │                 │    │ • 如果启用则记录    │ │ │
│  │  │ • 如果未找到    │    │ • "未知错误"    │    │   到调试文件        │ │ │
│  │  │   匹配          │    │ • 返回给        │    │ • 包含错误代码      │ │ │
│  │  │ • 使用默认      │    │   调用者        │    │ • 包含时间戳        │ │ │
│  │  │   情况          │    │                 │    │                     │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 调试日志流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        调试日志集成                                              │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    调试日志写入                                              │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   检查调试      │    │   写入错误      │    │   格式化日志        │ │ │
│  │  │   日志文件      │    │   信息          │    │   条目              │ │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 检查是否      │    │ • 时间戳        │    │ • 错误分隔符        │ │ │
│  │  │   设置了        │    │ • 退出代码      │    │ • 结构化格式        │ │ │
│  │  │   DEBUG_LOGFILE │    │ • 说明          │    │ • 易于解析          │ │ │
│  │  │ • 检查文件      │    │ • 行号          │    │ • 易于阅读          │ │ │
│  │  │   是否存在      │    │ • 命令          │    │                     │ │ │
│  │  │ • 检查文件      │    │ • 追加到文件    │    │                     │ │ │
│  │  │   是否可写      │    │                 │    │                     │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 集成点

### 与 core.func 的集成
- **静默执行**: 为 silent() 函数提供错误说明
- **颜色变量**: 使用颜色变量进行错误显示
- **日志集成**: 与 SILENT_LOGFILE 集成

### 与其他脚本的集成
- **错误陷阱**: 设置 ERR 陷阱以自动处理错误
- **信号陷阱**: 处理 SIGINT、SIGTERM 和 EXIT 信号
- **清理**: 在脚本退出时提供清理

### 外部依赖
- **无**: 纯 Bash 实现
- **颜色支持**: 需要来自 core.func 的颜色变量
- **日志文件**: 使用标准文件操作
