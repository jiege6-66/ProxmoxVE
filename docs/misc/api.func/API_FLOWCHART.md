# api.func 执行流程图

## 主要 API 通信流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        API 通信初始化                                           │
│  安装脚本调用 api.func 函数时的入口点                                           │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        先决条件检查                                             │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    先决条件验证                                             │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   检查 curl     │    │   检查          │    │   检查              │ │ │
│  │  │   可用性        │    │   诊断设置      │    │   Random UUID       │ │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • command -v    │    │ • DIAGNOSTICS   │    │ • RANDOM_UUID       │ │
│  │  │   curl          │    │   = "yes"       │    │   非空              │ │
│  │  │ • 如果未找到    │    │ • 如果禁用      │    │ • 如果未设置        │ │
│  │  │   则返回        │    │   则返回        │    │   则返回            │ │
│  │  │                 │    │                 │    │                     │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        数据收集                                                 │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    系统信息收集                                             │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   获取 PVE      │    │   收集          │    │   准备 JSON         │ │ │
│  │  │   版本          │    │   环境变量      │    │   负载              │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • pveversion    │    │ • CT_TYPE       │    │ • 创建 JSON         │ │
│  │  │   命令          │    │ • DISK_SIZE     │    │   结构              │ │
│  │  │ • 解析版本      │    │ • CORE_COUNT    │    │ • 包含所有          │ │
│  │  │ • 提取          │    │ • RAM_SIZE      │    │   变量              │ │
│  │  │   major.minor   │    │ • var_os        │    │ • 格式化为 API      │ │
│  │  │                 │    │ • var_version   │    │                     │ │
│  │  │                 │    │ • NSAPP         │    │                     │ │
│  │  │                 │    │ • METHOD        │    │                     │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        API 请求执行                                             │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    HTTP 请求处理                                            │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   准备          │    │   执行          │    │   处理              │ │ │
│  │  │   请求          │    │   HTTP 请求     │    │   响应              │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 设置 API URL  │    │ • curl -s -w    │    │ • 捕获 HTTP         │ │
│  │  │ • 设置标头      │    │   "%{http_code}"│    │   状态码            │ │
│  │  │ • 设置负载      │    │ • POST 请求     │    │ • 存储响应          │ │
│  │  │ • Content-Type  │    │ • JSON 数据     │    │ • 优雅地处理        │ │
│  │  │   application/  │    │ • 跟随          │    │   错误              │ │
│  │  │   json          │    │   重定向        │    │                     │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## LXC API 报告流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        POST_TO_API() 流程                                       │
│  向 API 发送 LXC 容器安装数据                                                   │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        LXC 数据准备                                             │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    LXC 特定数据收集                                         │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   设置 LXC      │    │   包含 LXC      │    │   设置状态          │ │ │
│  │  │   类型          │    │   变量          │    │   信息              │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • ct_type: 1    │    │ • DISK_SIZE     │    │ • status:           │ │
│  │  │ • type: "lxc"   │    │ • CORE_COUNT    │    │   "installing"      │ │
│  │  │ • 包含所有      │    │ • RAM_SIZE      │    │ • 包含所有          │ │
│  │  │   LXC 数据      │    │ • var_os        │    │   跟踪数据          │ │
│  │  │                 │    │ • var_version   │    │                     │ │
│  │  │                 │    │ • DISABLEIP6    │    │                     │ │
│  │  │                 │    │ • NSAPP         │    │                     │ │
│  │  │                 │    │ • METHOD        │    │                     │ │
│  │  │                 │    │ • pve_version   │    │                     │ │
│  │  │                 │    │ • random_id     │    │                     │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        JSON 负载创建                                            │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    JSON 结构生成                                            │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   创建 JSON     │    │   验证          │    │   格式化为          │ │ │
│  │  │   结构          │    │   数据          │    │   API 请求          │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 使用 heredoc  │    │ • 检查所有      │    │ • 确保正确的        │ │
│  │  │   语法          │    │   变量已设置    │    │   JSON 格式         │ │
│  │  │ • 包含所有      │    │ • 验证          │    │ • 转义特殊          │ │
│  │  │   必需字段      │    │   数据类型      │    │   字符              │ │
│  │  │ • 正确          │    │ • 处理          │    │ • 设置 content      │ │
│  │  │   格式化        │    │   缺失值        │    │   type              │ │
│  │  │                 │    │                 │    │                     │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## VM API 报告流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        POST_TO_API_VM() 流程                                    │
│  向 API 发送 VM 安装数据                                                        │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        VM 数据准备                                              │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    VM 特定数据收集                                          │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   检查          │    │   设置 VM       │    │   处理磁盘          │ │ │
│  │  │   诊断文件      │    │   类型          │    │   大小              │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 检查文件      │    │ • ct_type: 2    │    │ • 删除 'G'          │ │
│  │  │   存在          │    │ • type: "vm"    │    │   后缀              │ │
│  │  │ • 读取          │    │ • 包含所有      │    │ • 转换为            │ │
│  │  │   DIAGNOSTICS   │    │   VM 数据       │    │   数值              │ │
│  │  │   设置          │    │                 │    │ • 存储在            │ │
│  │  │ • 解析值        │    │                 │    │   DISK_SIZE_API     │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        VM JSON 负载创建                                         │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    VM 特定 JSON 结构                                        │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   包含 VM       │    │   设置 VM       │    │   格式化 VM         │ │ │
│  │  │   变量          │    │   状态          │    │   数据为 API        │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • DISK_SIZE_API │    │ • status:       │    │ • 确保正确的        │ │
│  │  │ • CORE_COUNT    │    │   "installing"  │    │   JSON 格式         │ │
│  │  │ • RAM_SIZE      │    │ • 包含所有      │    │ • 处理 VM 特定      │ │
│  │  │ • var_os        │    │   跟踪信息      │    │   数据              │ │
│  │  │ • var_version   │    │                 │    │ • 设置适当的        │ │
│  │  │ • NSAPP         │    │                 │    │   content type      │ │
│  │  │ • METHOD        │    │                 │    │                     │ │
│  │  │ • pve_version   │    │                 │    │                     │ │
│  │  │ • random_id     │    │                 │    │                     │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 状态更新流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        POST_UPDATE_TO_API() 流程                                │
│  向 API 发送安装完成状态                                                        │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        更新防止检查                                             │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    重复更新防止                                             │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   检查          │    │   如果首次      │    │   如果已更新        │ │ │
│  │  │   POST_UPDATE_  │    │   更新则设置    │    │   则提前返回        │ │
│  │  │   DONE          │    │   标志          │    │                     │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 检查是否      │    │ • 设置          │    │ • 返回 0            │ │
│  │  │   已更新        │    │   POST_UPDATE_  │    │ • 跳过 API 调用     │ │
│  │  │ • 防止          │    │   DONE=true     │    │ • 防止              │ │
│  │  │   重复请求      │    │ • 继续更新      │    │   重复请求          │ │
│  │  │                 │    │                 │    │                     │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        状态和错误处理                                           │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    状态确定                                                 │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   确定          │    │   获取错误      │    │   准备状态          │ │ │
│  │  │   状态          │    │   描述          │    │   数据              │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • status:       │    │ • 调用          │    │ • 包含状态          │ │
│  │  │   "success" 或  │    │   get_error_    │    │ • 包含错误          │ │
│  │  │   "failed"      │    │   description() │    │   描述              │ │
│  │  │ • 根据状态      │    │ • 获取人类      │    │ • 包含 random       │ │
│  │  │   设置退出码    │    │   可读错误      │    │   ID 用于跟踪       │ │
│  │  │ • 如果未设置    │    │   消息          │    │                     │ │
│  │  │   则默认为错误  │    │ • 处理未知      │    │                     │ │
│  │  │                 │    │   错误          │    │                     │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        状态更新 API 请求                                        │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    状态更新负载创建                                         │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   创建          │    │   发送状态      │    │   标记更新          │ │ │
│  │  │   状态 JSON     │    │   更新          │    │   完成              │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 包含状态      │    │ • POST 到       │    │ • 设置              │ │
│  │  │ • 包含错误      │    │   updatestatus  │    │   POST_UPDATE_      │ │
│  │  │   描述          │    │   端点          │    │   DONE=true         │ │
│  │  │ • 包含          │    │ • 包含 JSON     │    │ • 防止进一步        │ │
│  │  │   random_id     │    │   负载          │    │   更新              │ │
│  │  │                 │    │ • 优雅地处理    │    │ • 完成              │ │
│  │  │                 │    │   响应          │    │   过程              │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 错误描述流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        GET_ERROR_DESCRIPTION() 流程                             │
│  将数字退出代码转换为人类可读的解释                                             │
└─────────────────────┬───────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        错误代码分类                                             │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    错误代码类别                                             │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   一般          │    │   网络          │    │   LXC 特定          │ │ │
│  │  │   系统错误      │    │   错误          │    │   错误              │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 0-9: 基本     │    │ • 18: 连接      │    │ • 100-101: LXC      │ │
│  │  │   错误          │    │   失败          │    │   安装错误          │ │
│  │  │ • 126-128:      │    │ • 22: 无效      │    │ • 200-209: LXC      │ │
│  │  │   命令错误      │    │   参数          │    │   创建错误          │ │
│  │  │ • 129-143:      │    │ • 28: 无空间    │    │                     │ │
│  │  │   信号错误      │    │ • 35: 超时      │    │                     │ │
│  │  │ • 152: 资源     │    │ • 56: TLS 错误  │    │                     │ │
│  │  │   限制          │    │ • 60: SSL 证书  │    │                     │ │
│  │  │ • 255: 未知     │    │   错误          │    │                     │ │
│  │  │   严重错误      │    │                 │    │                     │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        错误消息返回                                             │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                    错误消息格式化                                           │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐ │ │
│  │  │   匹配错误      │    │   返回          │    │   默认情况          │ │ │
│  │  │   代码          │    │   描述          │    │                     │ │
│  │  │                 │    │                 │    │                     │ │
│  │  │ • 使用 case     │    │ • 返回人类      │    │ • 返回 "Unknown     │ │
│  │  │   语句          │    │   可读消息      │    │   error code        │ │
│  │  │ • 匹配特定      │    │ • 包含上下文    │    │   (exit_code)"      │ │
│  │  │   代码          │    │   信息          │    │ • 处理未识别        │ │
│  │  │ • 处理范围      │    │                 │    │   的代码            │ │
│  │  │                 │    │                 │    │ • 提供后备          │ │
│  │  │                 │    │                 │    │   消息              │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 集成点

### 与安装脚本
- **build.func**：发送 LXC 安装数据
- **vm-core.func**：发送 VM 安装数据
- **install.func**：报告安装状态
- **alpine-install.func**：报告 Alpine 安装数据

### 与错误处理
- **error_handler.func**：提供错误解释
- **core.func**：在静默执行中使用错误描述
- **诊断报告**：跟踪错误模式

### 外部依赖
- **curl**：用于 API 通信的 HTTP 客户端
- **Community Scripts API**：外部 API 端点
- **网络连接**：API 通信所需
